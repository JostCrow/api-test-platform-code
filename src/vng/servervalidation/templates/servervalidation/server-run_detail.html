{% extends 'master.html' %}
{% load django_bootstrap_breadcrumbs %}

{% block title %}Server-run detail{% endblock%}

{% block breadcrumb %}
{% breadcrumb "Home" 'server_run:server-run_list' %}
{% breadcrumb 'Detail' 'testsession:sessions' %}
{% render_breadcrumbs 'components/breadcrumbs/breadcrumbs.html' %}
{% endblock  %}

{% block content %}
<div id="ui-view">
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header">
                    View the detail of a provider test
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Property</th>
                                <th scope="col">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% include 'servervalidation/table/table-server-run.html' with server_run=object postman_result=postman_result request=request only %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% for postman in postman_result %}
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header">
                    Postman collection <a
                        href="{% url 'server_run:postman_download' postman.postman_test.pk %}">#{{ forloop.counter }}</a>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tbody>
                            {% for calls in postman.get_json_obj %}
                            <tr class="table-active">
                                {% if calls.response.code >= 200 and calls.response.code < 400 and not calls.item.error_test %}
                                <td>
                                    <b>{{calls.item.name}}</b>
                                </td>
                                <td>
                                </td>
                                <td>
                                    <p class='cui-check h2'></p>
                                </td>
                                {% else %}
                                <td>
                                    <b>{{calls.item.name}}</b>
                                </td>
                                <td>
                                </td>
                                <td>
                                    <p class='cui-circle-x h2'></p>
                                </td>
                                {% endif %}
                            </tr>
                            <tr>
                                <td>
                                    {{calls.request.url.url}}
                                </td>
                                <td>
                                    {{ calls.response.code }} {{ calls.response.status }}
                                </td>
                                <td>
                                    {% if calls.response.code >= 200 and calls.response.code < 400  %}
                                    <p class='cui-check h2'></p>
                                    {% else %}
                                    <p class='cui-circle-x h2'></p>
                                    {% endif %}
                                </td>
                            </tr>
                            {% for assertion in calls.assertions %}
                            {% if 'error' in assertion %}
                            <tr class="table-danger">
                                {% else %}
                            <tr>
                                {% endif %}
                                <td>
                                    {% if forloop.counter == 1 %}
                                    <u>Tests</u>
                                    {% endif %}
                                </td>
                                {% if 'error' in assertion %}
                                <td>
                                    {{assertion.assertion}}
                                </td>
                                <td>
                                    {{assertion.error.message}}
                                </td>
                                {% else %}
                                <td>
                                    {{assertion.assertion}}
                                </td>
                                <td class="table__cell ">
                                    <p class='cui-check h2'></p>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% if postman.get_json_obj_info.run.failures %}
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header">
                    Failure
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Error</th>
                                <th>Test</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for failure in postman.get_json_obj_info.run.failures %}
                            <tr>
                                <td>{{ failure.source.name }}</td>
                                <td>{{ failure.error.name }}</td>
                                <td>{{ failure.error.test }}</td>
                                <td>{{ failure.error.message }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header">
                    Assertions
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name call</th>
                                <th>Name assertion</th>
                                <th>Assertion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exec in postman.get_json_obj%}
                            {% if 'assertions' in exec %}
                            {% for assertion in exec.assertions %}
                            {% if 'error' not in assertion %}
                            <tr>
                                <td>{{ exec.item.name }}</td>
                                <td>{{ exec.request.url.url  }}</td>
                                <td>{{ assertion.assertion }}</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
