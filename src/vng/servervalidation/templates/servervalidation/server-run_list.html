{% extends 'master.html' %}
{% load sniplates %}


{% block title %}Providers{% endblock %}


{% block content %}
    <article class="article">
        <div class="article__section">
            <h1>Providers</h1>
            <h2>Start een nieuwe provider-test</h2>

            <form class="form" method="post">{% csrf_token %}
                {% load_widgets form='forms.html' %}

                {% for field in form %}
                    {% form_field field %}
                {% endfor %}

                <input type="submit" class="button button--primary" value="Volgende">
            </form>

            {% if object_list %}

            <div class="tabs">
                <nav class="tabs__navigation">
                    <ul class="tabs__list">
                        <li class="tabs__list-item">
                            <a class="tabs__link" href="#tab-sub-categories">Provider test</a>
                        </li>

                        <li class="tabs__list-item">
                            <a class="tabs__link" href="#tab-news-items">Scheduled</a>
                        </li>
                    </ul>
                </nav>
                <div class="tabs__track">
                    <div id="tab-sub-categories" class="tabs__tab">
                        <h2>Provider tests</h2>
                        <table class="table">
                            {% include 'components/table/header-server-run.html' only %}
                            {% for server_run in object_list %}
                                {% if not server_run.scheduled %}
                                    {% include 'components/table/row-server-run.html' with server_run=server_run %}
                                {% endif %}
                            {% endfor %}
                        </table>
                    </div>
                    <div id="tab-news-items" class="tabs__tab">
                        <h2>Scheduled</h2>
                        <table class="table" >
                            {% include 'components/table/header-server-run-scheduled.html' only %}
                            {% for server_run in object_list %}
                                {% if server_run.scheduled %}
                                    {% include 'components/table/row-server-run-scheduled.html' with server_run=server_run %}
                                {% endif %}
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>





                {% include 'components/pagination/pagination.html' %}
            {% endif %}
        </div>

    </article>
{% endblock %}


{% block script %}
obj = $("#starting")

function update(){
    $.ajax({
        url:  window.location.origin+"/api/v1/provider-run/" + obj.attr('server_run_id')+'/',
        success: (data, textStatus, jqXHR)=>{
            server_run = data
            console.log(data)
            if (server_run.percentage_exec) {
            obj.html(`${server_run.status_exec}: ${server_run.percentage_exec}%<br /><div style='background-color: green; width: ${ server_run.percentage_exec}%; height: 20px;'></div>`)
            if (server_run.percentage_exec<100)
                setTimeout(() => {
                    update();
                }, 1000);
            if (server_run.percentage_exec == 100) {
                setTimeout(() => {
                location.reload();
                }, 2000);
            }
            }
        }
    })
}


if(obj.length ==1){
    update()
}

{% endblock %}
